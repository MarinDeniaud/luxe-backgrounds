!================================================================================
!
!----- Magnet setting for the beamline leading to the dump T5D (SASE2)
!
!----- Starting at Z = 37.6484 m, in the front of 1st cold quadrupole Q.A1.1.I1
!
!----- LINE = (I1_L0C8, L1, B1, L2, B2, L3, CL, TL1, TL2TL, TL3T1, TD1)
!
!----- TD1 = (T1, SA2, T3, UN1, T5, UN2, T5D)
!
!================================================================================


!--------------------------------------------------------------------------------
!----- Injector I1
!--------------------------------------------------------------------------------

call, "MAGNET_SET_I1.txm"

!--------------------------------------------------------------------------------
!----- BC1: different FODO in diagnostic section
!--------------------------------------------------------------------------------

call, "MAGNET_SET_B1.txm"

!--------------------------------------------------------------------------------
!----- BC2: different FODO in diagnostic section
!--------------------------------------------------------------------------------

call, "MAGNET_SET_B2.txm"

!--------------------------------------------------------------------------------
!----- CL: different optics (FODO transport, collimation)
!--------------------------------------------------------------------------------

call, "MAGNET_SET_COLL.txm"

!--------------------------------------------------------------------------------
!----- LINACs
!--------------------------------------------------------------------------------

call, "MAGNET_SET_LINAC.txm"

!--------------------------------------------------------------------------------
!----- Part of TL (TL1, TL2TL, TL3T1) 
!--------------------------------------------------------------------------------

call, "MAGNET_SET_TL.txm"

!--------------------------------------------------------------------------------
!----- TD1 (T1, SA2, T3, UN1, T5, UN2, T5D)
!--------------------------------------------------------------------------------

call, "MAGNET_SET_TD1.txm"


!--------------------------------------------------------------------------------
!----- Setting for KS kickers and TLD HELP elements (if run after TLD)
!--------------------------------------------------------------------------------

! KS kickers are RBEND with zero angle
set, KS.1.TL[ANGLE],     0

! HELP are RBEND with zero angle
set, HELP.1a.TLD[ANGLE], 0
set, HELP.1b.TLD[ANGLE], 0
set, HELP.2a.TLD[ANGLE], 0
set, HELP.2b.TLD[ANGLE], 0
set, HELP.3a.TLD[ANGLE], 0
set, HELP.3b.TLD[ANGLE], 0

!--------------------------------------------------------------------------------
!----- Setting for KL kickers and T1 HELP elements (for survey only)
!--------------------------------------------------------------------------------

yQF1_TD1:=1
yQF2_TD1:=1
xQK1_TD1:=1
xQK2_TD1:=1
yQK1_TD1:=1
yQK2_TD1:=1

! Setting from 19.11.2015
!set, yQF1_TD1,              +5.9281670899e-03
!set, yQF2_TD1,              +6.0599980442e-03
!set, xQK1_TD1,              +7.2199067811e-03 *1.00067
!set, xQK2_TD1,              +9.1217056123e-03 *0.99976
!set, yQK1_TD1,              +2.3348929007e-02 *1.00071
!set, yQK2_TD1,              +2.3727368979e-02 *0.99982086


setTD1lay: subroutine

! KL kickers are defined as RBEND
set, KL.1.TL[ANGLE],      -ANG_KL_TD1
set, KL.2.TL[ANGLE],       0.0

set, yQF1_TD1,              +5.9321212705e-03
set, yQF2_TD1,              +6.0560438645e-03

set, HELP.1a.T1[ANGLE], -0.5*QF.1.TL[K1]*QF.1.TL[L]*yQF1_TD1
set, HELP.1b.T1[ANGLE], -0.5*QF.1.TL[K1]*QF.1.TL[L]*yQF2_TD1
set, HELP.1a.T1[TILT],  +pi/2
set, HELP.1b.T1[TILT],  +pi/2

! Nov 2016
set, xQK1_TD1,              +7.2696790071e-03 *1.00067
set, yQK1_TD1,              +2.3358762560e-02 *1.00071
set, xQK2_TD1,              +9.0719333863e-03 *0.99976
set, yQK2_TD1,              +2.3717535426e-02 *0.99982086

set, HELP.2a.T1[ANGLE],  &
     0.5*QK.2.TL[K1]*QK.2.TL[L]*xQK1_TD1/cos(atan(yQK1_TD1/xQK1_TD1))
set, HELP.2a.T1[TILT],  -atan(yQK1_TD1/xQK1_TD1)

set, HELP.2b.T1[ANGLE],  &
     0.5*QK.2.TL[K1]*QK.2.TL[L]*xQK2_TD1/cos(atan(yQK2_TD1/xQK2_TD1))
set, HELP.2b.T1[TILT],  -atan(yQK2_TD1/xQK2_TD1)

endsubroutine

!================================================================================
!================================================================================



